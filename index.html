<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>OmniChat Ultimate v21</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #000000; color: #e5e7eb; font-family: ui-sans-serif, system-ui, sans-serif; -webkit-tap-highlight-color: transparent; overflow: hidden; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 10px; }
        
        /* Glass Styles */
        .glass-panel { background: rgba(20, 20, 23, 0.75); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-sidebar { background: rgba(10, 10, 12, 0.9); backdrop-filter: blur(30px); border-right: 1px solid rgba(255, 255, 255, 0.08); }
        .glass-bubble-user { background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); box-shadow: 0 2px 12px rgba(124, 58, 237, 0.25); }
        .glass-bubble-bot { background: rgba(255, 255, 255, 0.08); border: 1px solid rgba(255, 255, 255, 0.05); }
        
        /* Mobile Optimizations */
        .mobile-input-bar { background: rgba(5, 5, 5, 0.9); backdrop-filter: blur(30px); border-top: 1px solid rgba(255, 255, 255, 0.1); }
        .safe-bottom { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        @keyframes blob { 0% { transform: translate(0,0) scale(1); } 50% { transform: translate(20px, -20px) scale(1.1); } 100% { transform: translate(0,0) scale(1); } }
        .animate-blob { animation: blob 10s infinite ease-in-out alternate; }
        
        @keyframes fade-in-up { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in-up { animation: fade-in-up 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'https://esm.sh/react@18.2.0';
        import { createRoot } from 'https://esm.sh/react-dom@18.2.0/client';
        import { Send, Settings, Image as ImageIcon, X, Loader2, Bot, User, Brain, ChevronDown, ChevronUp, Trash2, Link as LinkIcon, Edit3, AlertTriangle, ExternalLink, RefreshCw, Zap, Sparkles, MessageSquarePlus, Palette, Video, Film, Wand2, ChevronRight, Download, Mic, Volume2, Menu, Plus, MessageSquare, MoreHorizontal, ShieldCheck, Globe, Coffee, Heart } from 'https://esm.sh/lucide-react@0.263.1';

        // --- Localization Data ---
        const TRANSLATIONS = {
            'zh-CN': {
                title: 'OmniChat',
                subtitle: 'ÂÖ®ËÉΩÂ§öÊ®°ÊÄÅ AI Â∑•‰ΩúÁ´ô',
                newChat: 'Êñ∞Âª∫ÂØπËØù',
                settings: 'ËÆæÁΩÆ',
                donate: 'ËµûÂä©‰ΩúËÄÖ',
                donateTitle: 'ËØ∑‰ΩúËÄÖÂñùÊùØÂíñÂï° ‚òï',
                donateDesc: 'Â¶ÇÊûúÊÇ®ÂñúÊ¨¢ OmniChatÔºåÊ¨¢ËøéÊâìËµèÊîØÊåÅÂêéÁª≠ÂºÄÂèëÔºÅÊÇ®ÁöÑÊîØÊåÅÊòØÊàëÊõ¥Êñ∞ÁöÑÂä®Âäõ„ÄÇ',
                scanPay: 'ÊâìÂºÄ ÊîØ‰ªòÂÆù/ÂæÆ‰ø° Êâ´‰∏ÄÊâ´',
                welcome: 'ÂºÄÂßã‰∏Ä‰∏™Êñ∞ÁöÑÂØπËØù...',
                chatMode: 'ÂØπËØùÊ®°Âºè',
                imageMode: 'ÁªòÂõæÊ®°Âºè',
                videoMode: 'ËßÜÈ¢ëÊ®°Âºè',
                inputChat: 'ÂèëÈÄÅÊ∂àÊÅØ...',
                inputImage: 'ÊèèËø∞ÁîªÈù¢ÂÜÖÂÆπ...',
                inputVideo: 'ÊèèËø∞ËßÜÈ¢ëÂÜÖÂÆπ...',
                listening: 'Ê≠£Âú®ËÅÜÂê¨...',
                configTitle: 'Á≥ªÁªüËÆæÁΩÆ',
                apiConfig: 'API ÈÖçÁΩÆ',
                models: 'Ê®°ÂûãÈÖçÁΩÆ',
                systemPrompt: 'Á≥ªÁªü‰∫∫ËÆæ (System Prompt)',
                save: '‰øùÂ≠òÂπ∂ÂÖ≥Èó≠',
                designedBy: 'Designed by Chenhao Huang',
                refresh: 'Âà∑Êñ∞ÂàóË°®',
                updating: 'Ëé∑Âèñ‰∏≠...',
                updated: 'Â∑≤Êõ¥Êñ∞',
                failed: 'Â§±Ë¥•',
                modelsCount: '‰∏™Ê®°Âûã',
                keyError: 'ËØ∑Â°´ÂÜô API Key',
                genStart: 'ÁîüÊàê‰∏≠...',
                genSuccess: 'ÁîüÊàêÊàêÂäü',
                genFail: 'ÁîüÊàêÂ§±Ë¥•',
                loadFail: 'Âä†ËΩΩÂ§±Ë¥•',
                retry: 'ÈáçËØï',
                guideTitle: 'Âø´ÈÄü‰∏äÊâãÊåáÂçó',
                step1: 'ÈÖçÁΩÆ API ÂØÜÈí•',
                step1Desc: 'ÁÇπÂáªËÆæÁΩÆÂõæÊ†áÔºåÂ°´ÂÖ• API Key„ÄÇ',
                step2: 'Â§öÊ®°ÊÄÅÂàáÊç¢',
                step2Desc: 'Ëá™Áî±ÂàáÊç¢ Chat/Image/Video Ê®°Âºè„ÄÇ',
                step3: 'ËØ≠Èü≥‰∏éÂ§ö‰ºöËØù',
                step3Desc: 'ÊîØÊåÅËØ≠Èü≥ËæìÂÖ•‰∏éÊúóËØªÔºåÊîØÊåÅÂ§ö‰ºöËØùÁÆ°ÁêÜ„ÄÇ',
                disclaimerTitle: 'Â£∞Êòé',
                privacy: 'ÈöêÁßÅÂÆâÂÖ®',
                privacyDesc: 'Key ‰ªÖÊú¨Âú∞Â≠òÂÇ®„ÄÇ',
                contentSafe: 'ÂÜÖÂÆπÂÖçË¥£',
                contentSafeDesc: 'ÁîüÊàêÂÜÖÂÆπ‰ªÖ‰æõÂèÇËÄÉ„ÄÇ',
                startBtn: 'ÊàëÂ∑≤‰∫ÜËß£ÔºåÂºÄÂßã‰ΩøÁî®'
            },
            'zh-TW': {
                title: 'OmniChat',
                donate: 'Ë¥äÂä©‰ΩúËÄÖ',
                donateTitle: 'Ë´ã‰ΩúËÄÖÂñùÊùØÂíñÂï° ‚òï',
                donateDesc: 'Â¶ÇÊûúÊÇ®ÂñúÊ≠° OmniChatÔºåÊ≠°ËøéÊâìË≥ûÊîØÊåÅÂæåÁ∫åÈñãÁôºÔºÅÊÇ®ÁöÑÊîØÊåÅÊòØÊàëÊõ¥Êñ∞ÁöÑÂãïÂäõ„ÄÇ',
                scanPay: 'ÈñãÂïü ÊîØ‰ªòÂØ∂/ÂæÆ‰ø° ÊéÉ‰∏ÄÊéÉ',
                newChat: 'Êñ∞Â¢ûÂ∞çË©±',
                settings: 'Ë®≠ÂÆö',
                welcome: 'ÈñãÂßã‰∏ÄÂÄãÊñ∞ÁöÑÂ∞çË©±...',
                chatMode: 'Â∞çË©±Ê®°Âºè',
                imageMode: 'Áπ™ÂúñÊ®°Âºè',
                videoMode: 'ÂΩ±ÁâáÊ®°Âºè',
                inputChat: 'ÂÇ≥ÈÄÅË®äÊÅØ...',
                inputImage: 'ÊèèËø∞Áï´Èù¢ÂÖßÂÆπ...',
                inputVideo: 'ÊèèËø∞ÂΩ±ÁâáÂÖßÂÆπ...',
                listening: 'Ê≠£Âú®ËÅÜËÅΩ...',
                configTitle: 'Á≥ªÁµ±Ë®≠ÂÆö',
                apiConfig: 'API ÈÖçÁΩÆ',
                models: 'Ê®°ÂûãÈÖçÁΩÆ',
                systemPrompt: 'Á≥ªÁµ±‰∫∫Ë®≠ (System Prompt)',
                save: 'ÂÑ≤Â≠ò‰∏¶ÈóúÈñâ',
                designedBy: 'Designed by Chenhao Huang',
                refresh: 'ÈáçÊñ∞Êï¥ÁêÜ',
                updating: 'Áç≤Âèñ‰∏≠...',
                updated: 'Â∑≤Êõ¥Êñ∞',
                failed: 'Â§±Êïó',
                modelsCount: 'ÂÄãÊ®°Âûã',
                keyError: 'Ë´ãÂ°´ÂØ´ API Key',
                genStart: 'ÁîüÊàê‰∏≠...',
                genSuccess: 'ÁîüÊàêÊàêÂäü',
                genFail: 'ÁîüÊàêÂ§±Êïó',
                loadFail: 'Âä†ËºâÂ§±Êïó',
                retry: 'ÈáçË©¶',
                guideTitle: 'Âø´ÈÄü‰∏äÊâãÊåáÂçó',
                step1: 'ÈÖçÁΩÆ API ÈáëÈë∞',
                step1Desc: 'ÈªûÊìäË®≠ÂÆöÂúñÁ§∫ÔºåÂ°´ÂÖ• API Key„ÄÇ',
                step2: 'Â§öÊ®°ÊÖãÂàáÊèõ',
                step2Desc: 'Ëá™Áî±ÂàáÊèõ Chat/Image/Video Ê®°Âºè„ÄÇ',
                step3: 'Ë™ûÈü≥ËàáÂ§öÊúÉË©±',
                step3Desc: 'ÊîØÊè¥Ë™ûÈü≥Ëº∏ÂÖ•ËàáÊúóËÆÄÔºåÊîØÊè¥Â§öÊúÉË©±ÁÆ°ÁêÜ„ÄÇ',
                disclaimerTitle: 'ËÅ≤Êòé',
                privacy: 'Èö±ÁßÅÂÆâÂÖ®',
                privacyDesc: 'Key ÂÉÖÊú¨Âú∞Â≠òÂÑ≤„ÄÇ',
                contentSafe: 'ÂÖßÂÆπÂÖçË≤¨',
                contentSafeDesc: 'ÁîüÊàêÂÖßÂÆπÂÉÖ‰æõÂèÉËÄÉ„ÄÇ',
                startBtn: 'ÊàëÂ∑≤Áû≠Ëß£ÔºåÈñãÂßã‰ΩøÁî®'
            },
            'en-US': {
                title: 'OmniChat',
                donate: 'Sponsor',
                donateTitle: 'Buy me a Coffee ‚òï',
                donateDesc: 'If you like OmniChat, consider supporting its development! Your support keeps updates coming.',
                scanPay: 'Scan with Alipay / WeChat',
                newChat: 'New Chat',
                settings: 'Settings',
                welcome: 'Start a new conversation...',
                chatMode: 'Chat Mode',
                imageMode: 'Image Mode',
                videoMode: 'Video Mode',
                inputChat: 'Send a message...',
                inputImage: 'Describe image...',
                inputVideo: 'Describe video...',
                listening: 'Listening...',
                configTitle: 'Settings',
                apiConfig: 'API Configuration',
                models: 'Model Configuration',
                systemPrompt: 'System Prompt',
                save: 'Save & Close',
                designedBy: 'Designed by Chenhao Huang',
                refresh: 'Refresh List',
                updating: 'Fetching...',
                updated: 'Updated',
                failed: 'Failed',
                modelsCount: 'models',
                keyError: 'API Key Missing',
                genStart: 'Generating...',
                genSuccess: 'Generated',
                genFail: 'Failed',
                loadFail: 'Load Failed',
                retry: 'Retry',
                guideTitle: 'Quick Start Guide',
                step1: 'Set API Key',
                step1Desc: 'Click settings icon and enter your API Key.',
                step2: 'Multi-Modal',
                step2Desc: 'Switch between Chat, Image, and Video modes.',
                step3: 'Voice & Sessions',
                step3Desc: 'Supports voice input/TTS and multi-session management.',
                disclaimerTitle: 'Disclaimer',
                privacy: 'Privacy',
                privacyDesc: 'Keys stored locally only.',
                contentSafe: 'Content',
                contentSafeDesc: 'AI content for reference only.',
                startBtn: 'Get Started'
            },
            'ja-JP': {
                title: 'OmniChat',
                donate: 'ÂØÑ‰ªò',
                donateTitle: '„Ç≥„Éº„Éí„Éº„ÇíÂ•¢„Çã ‚òï',
                donateDesc: 'OmniChat„ÅåÊ∞ó„Å´ÂÖ•„Å£„Åü„Çâ„ÄÅÈñãÁô∫„Çí„Çµ„Éù„Éº„Éà„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºÅ',
                scanPay: 'Alipay / WeChat „Åß„Çπ„Ç≠„É£„É≥',
                newChat: 'Êñ∞Ë¶è„ÉÅ„É£„ÉÉ„Éà',
                settings: 'Ë®≠ÂÆö',
                welcome: 'Êñ∞„Åó„ÅÑ‰ºöË©±„ÇíÂßã„ÇÅ„Çã...',
                chatMode: '„ÉÅ„É£„ÉÉ„Éà',
                imageMode: 'ÁîªÂÉèÁîüÊàê',
                videoMode: 'ÂãïÁîªÁîüÊàê',
                inputChat: '„É°„ÉÉ„Çª„Éº„Ç∏„ÇíÈÄÅ‰ø°...',
                inputImage: 'ÁîªÂÉè„ÅÆÂÜÖÂÆπ„ÇíË®òËø∞...',
                inputVideo: 'ÂãïÁîª„ÅÆÂÜÖÂÆπ„ÇíË®òËø∞...',
                listening: 'ËÅû„ÅçÂèñ„Çä‰∏≠...',
                configTitle: '„Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö',
                apiConfig: 'APIË®≠ÂÆö',
                models: '„É¢„Éá„É´Ë®≠ÂÆö',
                systemPrompt: '„Ç∑„Çπ„ÉÜ„É†„Éó„É≠„É≥„Éó„Éà',
                save: '‰øùÂ≠ò„Åó„Å¶Èñâ„Åò„Çã',
                designedBy: 'Designed by Chenhao Huang',
                refresh: 'Êõ¥Êñ∞',
                updating: 'ÂèñÂæó‰∏≠...',
                updated: 'Êõ¥Êñ∞ÂÆå‰∫Ü',
                failed: 'Â§±Êïó',
                modelsCount: '„É¢„Éá„É´',
                keyError: 'API„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ',
                genStart: 'ÁîüÊàê‰∏≠...',
                genSuccess: 'ÁîüÊàêÂÆå‰∫Ü',
                genFail: 'ÁîüÊàêÂ§±Êïó',
                loadFail: 'Ë™≠ËæºÂ§±Êïó',
                retry: 'ÂÜçË©¶Ë°å',
                guideTitle: '„ÇØ„Ç§„ÉÉ„ÇØ„Ç¨„Ç§„Éâ',
                step1: 'API„Ç≠„ÉºË®≠ÂÆö',
                step1Desc: 'Ë®≠ÂÆö„Ç¢„Ç§„Ç≥„É≥„Çí„ÇØ„É™„ÉÉ„ÇØ„Åó„ÄÅAPI„Ç≠„Éº„ÇíÂÖ•Âäõ„Åó„Åæ„Åô„ÄÇ',
                step2: '„Éû„É´„ÉÅ„É¢„Éº„ÉÄ„É´',
                step2Desc: '„ÉÅ„É£„ÉÉ„Éà„ÄÅÁîªÂÉè„ÄÅÂãïÁîª„É¢„Éº„Éâ„ÇíËá™Áî±„Å´Âàá„ÇäÊõø„Åà„ÄÇ',
                step3: 'Èü≥Â£∞„Å®„Çª„ÉÉ„Ç∑„Éß„É≥',
                step3Desc: 'Èü≥Â£∞ÂÖ•Âäõ/Ë™≠„Åø‰∏ä„Åí„ÄÅ„Éû„É´„ÉÅ„Çª„ÉÉ„Ç∑„Éß„É≥ÁÆ°ÁêÜ„Å´ÂØæÂøú„ÄÇ',
                disclaimerTitle: 'ÂÖçË≤¨‰∫ãÈ†Ö',
                privacy: '„Éó„É©„Ç§„Éê„Ç∑„Éº',
                privacyDesc: '„Ç≠„Éº„ÅØ„É≠„Éº„Ç´„É´„Å´„ÅÆ„Åø‰øùÂ≠ò„Åï„Çå„Åæ„Åô„ÄÇ',
                contentSafe: '„Ç≥„É≥„ÉÜ„É≥„ÉÑ',
                contentSafeDesc: 'ÁîüÊàêÂÜÖÂÆπ„ÅØÂèÇËÄÉÁî®„Åß„Åô„ÄÇ',
                startBtn: 'Âßã„ÇÅ„Çã'
            }
        };

        const DEFAULT_CONFIG = {
            api: { 
                name: 'Ëá™ÂÆö‰πâ API', baseUrl: 'https://api.bltcy.ai/v1', apiKey: '', 
                chatModel: 'gpt-5.1', reasoningModel: 'deepseek-reasoner', 
                imageModel: 'midjourney', videoModel: 'luma-dream-machine', 
                systemPrompt: '', 
                isCustom: true 
            },
            gemini: { apiKey: '', isEnabled: true },
            language: 'zh-CN'
        };

        // --- Components ---
        
        // Êñ∞Â¢ûÔºöÊçêËµ†ÂºπÁ™ó
        const DonationModal = ({ onClose, t }) => {
            // Ê≥®ÊÑèÔºöËøôÈáå‰ΩøÁî®‰∫Ü‰∏Ä‰∏™Âç†‰ΩçÁ¨¶ÂõæÁâáÂú∞ÂùÄ„ÄÇ
            // ËØ∑Â∞ÜÊÇ®ÁöÑ‰∫åÁª¥Á†ÅÂõæÁâáÈáçÂëΩÂêç‰∏∫ "qr.png" Âπ∂ÊîæÂú®‰∏éÊú¨ HTML Êñá‰ª∂Áõ∏ÂêåÁöÑÊñá‰ª∂Â§π‰∏≠Ôºå
            // ÊàñËÄÖÁõ¥Êé•Â∞Ü‰∏ãÊñπÁöÑ src ÊõøÊç¢‰∏∫ÊÇ®ÁöÑ‰∫åÁª¥Á†ÅÂõæÁâáÁöÑ Base64 ÁºñÁ†ÅÊàñÁΩëÁªúÈìæÊé•„ÄÇ
            const qrCodeUrl = "qr.png"; // <--- ËØ∑ÊõøÊç¢ËøôÈáåÁöÑÂú∞ÂùÄ

            return (
                <div className="fixed inset-0 z-[110] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in duration-300" onClick={onClose}>
                    <div className="w-full max-w-sm bg-[#18181b] border border-amber-500/30 rounded-[2rem] shadow-2xl overflow-hidden flex flex-col animate-fade-in-up relative" onClick={e => e.stopPropagation()}>
                        <div className="absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-amber-400 via-orange-500 to-amber-400"></div>
                        
                        <div className="p-8 flex flex-col items-center text-center space-y-6">
                            <div className="w-16 h-16 bg-gradient-to-br from-amber-400 to-orange-600 rounded-full flex items-center justify-center shadow-lg shadow-orange-500/20 mb-2">
                                <Coffee size={32} className="text-white" />
                            </div>
                            
                            <div>
                                <h3 className="text-xl font-bold text-white mb-2">{t('donateTitle')}</h3>
                                <p className="text-sm text-gray-400 leading-relaxed px-4">{t('donateDesc')}</p>
                            </div>

                            <div className="p-1 bg-white rounded-xl">
                                <div className="w-48 h-48 bg-gray-200 rounded-lg overflow-hidden flex items-center justify-center relative">
                                    {/* ‰∫åÁª¥Á†ÅÊòæÁ§∫Âå∫Âüü */}
                                    <img 
                                        src={qrCodeUrl} 
                                        alt="QR Code" 
                                        className="w-full h-full object-cover"
                                        onError={(e) => {
                                            e.target.onerror = null;
                                            e.target.src = "https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=ChenhaoHuang-Donation"; // ÈªòËÆ§ÂÖúÂ∫ï
                                            // ÊèêÁ§∫Áî®Êà∑
                                            e.target.parentElement.classList.add("bg-gray-800");
                                        }}
                                    />
                                </div>
                            </div>
                            
                            <div className="text-[10px] text-gray-500 uppercase tracking-widest font-medium flex items-center gap-2">
                                <Heart size={10} className="text-red-500 fill-red-500 animate-pulse" />
                                {t('scanPay')}
                            </div>
                        </div>

                        <button onClick={onClose} className="absolute top-4 right-4 p-2 text-gray-500 hover:text-white transition-colors bg-white/5 hover:bg-white/10 rounded-full">
                            <X size={16} />
                        </button>
                    </div>
                </div>
            );
        };

        const WelcomeModal = ({ onClose, t }) => {
            return (
                <div className="fixed inset-0 z-[100] bg-black/90 backdrop-blur-md flex items-center justify-center p-4 animate-in fade-in duration-500">
                    <div className="w-full max-w-md bg-[#121214] border border-white/10 rounded-[2rem] shadow-2xl overflow-hidden flex flex-col max-h-[90vh] animate-fade-in-up">
                        <div className="relative h-32 bg-gradient-to-br from-indigo-600 to-violet-700 flex items-center justify-center overflow-hidden shrink-0">
                            <div className="absolute inset-0 bg-[url('https://grainy-gradients.vercel.app/noise.svg')] opacity-20"></div>
                            <div className="absolute top-[-50%] left-[-50%] w-[200%] h-[200%] animate-blob opacity-30 bg-white blur-3xl"></div>
                            <div className="relative z-10 text-center">
                                <div className="w-12 h-12 bg-white/20 backdrop-blur-md rounded-2xl flex items-center justify-center mx-auto mb-3 shadow-lg border border-white/10">
                                    <Zap size={28} className="text-white" />
                                </div>
                                <h2 className="text-2xl font-bold text-white tracking-tight">{t('title')}</h2>
                                <p className="text-white/70 text-xs uppercase tracking-widest mt-1">{t('subtitle')}</p>
                            </div>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6">
                            <div className="space-y-3">
                                <h3 className="text-xs font-bold text-indigo-400 uppercase tracking-wider flex items-center gap-2">
                                    <Sparkles size={14} /> {t('guideTitle')}
                                </h3>
                                <div className="space-y-4">
                                    <div className="flex gap-3">
                                        <div className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center shrink-0 text-xs font-bold text-white border border-white/5">1</div>
                                        <div>
                                            <h4 className="text-sm font-medium text-gray-200">{t('step1')}</h4>
                                            <p className="text-xs text-gray-500 mt-0.5 leading-relaxed">{t('step1Desc')}</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center shrink-0 text-xs font-bold text-white border border-white/5">2</div>
                                        <div>
                                            <h4 className="text-sm font-medium text-gray-200">{t('step2')}</h4>
                                            <p className="text-xs text-gray-500 mt-0.5 leading-relaxed">{t('step2Desc')}</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-3">
                                        <div className="w-6 h-6 rounded-full bg-white/10 flex items-center justify-center shrink-0 text-xs font-bold text-white border border-white/5">3</div>
                                        <div>
                                            <h4 className="text-sm font-medium text-gray-200">{t('step3')}</h4>
                                            <p className="text-xs text-gray-500 mt-0.5 leading-relaxed">{t('step3Desc')}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="h-px bg-white/5"></div>
                            <div className="space-y-3">
                                <h3 className="text-xs font-bold text-gray-400 uppercase tracking-wider flex items-center gap-2">
                                    <ShieldCheck size={14} /> {t('disclaimerTitle')}
                                </h3>
                                <div className="p-3 bg-white/5 rounded-xl border border-white/5 text-[10px] text-gray-400 space-y-2 leading-relaxed">
                                    <p>üîí <strong>{t('privacy')}</strong>Ôºö{t('privacyDesc')}</p>
                                    <p>‚ö†Ô∏è <strong>{t('contentSafe')}</strong>Ôºö{t('contentSafeDesc')}</p>
                                </div>
                            </div>
                        </div>
                        <div className="p-6 pt-2 bg-[#121214] border-t border-white/5 shrink-0">
                            <button onClick={onClose} className="w-full py-3.5 bg-indigo-600 hover:bg-indigo-500 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-900/20 transition-all active:scale-[0.98] flex items-center justify-center gap-2">
                                {t('startBtn')} <ChevronRight size={16} />
                            </button>
                            <p className="text-center text-[10px] text-gray-600 mt-4 uppercase tracking-widest">{t('designedBy')}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const MarkdownRenderer = ({ content }) => {
            if (!content) return null;
            const parseInline = (text) => {
                const codeSegments = text.split(/(`[^`]+`)/g);
                return codeSegments.map((seg, i) => {
                    if (seg.startsWith('`') && seg.endsWith('`')) return <code key={i} className="bg-white/10 text-indigo-300 px-1.5 py-0.5 rounded text-xs font-mono border border-white/5 mx-0.5">{seg.slice(1, -1)}</code>;
                    const boldSegments = seg.split(/(\*\*[^*]+\*\*)/g);
                    return boldSegments.map((bSeg, j) => {
                        if (bSeg.startsWith('**') && bSeg.endsWith('**')) return <strong key={`${i}-${j}`} className="text-white font-extrabold mx-0.5">{bSeg.slice(2, -2)}</strong>;
                        return bSeg;
                    });
                });
            };
            const parts = content.split(/(```[\s\S]*?```)/g);
            return (
                <div className="break-words text-[14px] leading-relaxed text-gray-200 font-sans space-y-2">
                    {parts.map((part, index) => {
                        if (part.startsWith('```')) {
                            const match = part.match(/```(\w*)\n([\s\S]*?)```/);
                            const code = match ? match[2] : part.slice(3, -3);
                            const lang = match ? match[1] : '';
                            return (
                                <div key={index} className="bg-black/50 rounded-lg my-3 border border-white/10 overflow-hidden">
                                    <div className="flex items-center justify-between bg-white/5 px-3 py-1.5 border-b border-white/5">
                                        <span className="text-[10px] text-gray-400 font-mono font-bold uppercase">{lang || 'CODE'}</span>
                                        <button onClick={() => navigator.clipboard.writeText(code)} className="text-[10px] text-gray-400 hover:text-white transition-colors">Copy</button>
                                    </div>
                                    <pre className="p-3 overflow-x-auto text-gray-300 font-mono text-xs"><code className="whitespace-pre">{code}</code></pre>
                                </div>
                            );
                        }
                        const lines = part.split('\n');
                        const elements = [];
                        let tableBuffer = [];
                        for (let i = 0; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (line.startsWith('|') || (line.split('|').length > 2 && line.includes('-'))) {
                                tableBuffer.push(line);
                                const nextLine = lines[i+1]?.trim();
                                if (!nextLine || (!nextLine.startsWith('|') && nextLine.split('|').length < 3)) {
                                    if (tableBuffer.length >= 2 && tableBuffer[1].includes('---')) {
                                        const headerRow = tableBuffer[0].split('|').filter(c => c.trim()).map(c => c.trim());
                                        const bodyRows = tableBuffer.slice(2).map(r => r.split('|').filter(c => c.trim()).map(c => c.trim()));
                                        elements.push(
                                            <div key={`table-${i}`} className="overflow-x-auto my-3 border border-white/10 rounded-lg bg-white/5">
                                                <table className="min-w-full text-xs text-left text-gray-300">
                                                    <thead className="bg-white/5 uppercase font-bold text-gray-200"><tr>{headerRow.map((h, hi) => <th key={hi} className="px-4 py-2 border-b border-white/10 whitespace-nowrap">{parseInline(h)}</th>)}</tr></thead>
                                                    <tbody>{bodyRows.map((row, ri) => (<tr key={ri} className="border-b border-white/5 last:border-0 hover:bg-white/5 transition-colors">{row.map((cell, ci) => <td key={ci} className="px-4 py-2 align-top">{parseInline(cell)}</td>)}</tr>))}</tbody>
                                                </table>
                                            </div>
                                        );
                                    } else tableBuffer.forEach((l, li) => elements.push(<p key={`p-tbl-${i}-${li}`} className="mb-1">{parseInline(l)}</p>));
                                    tableBuffer = [];
                                }
                                continue;
                            }
                            if (line === '') { elements.push(<div key={`br-${i}`} className="h-2"></div>); continue; }
                            if (line.startsWith('### ')) { elements.push(<h3 key={`h3-${i}`} className="text-base font-bold text-white mt-4 mb-2">{parseInline(line.slice(4))}</h3>); continue; }
                            if (line.startsWith('## ')) { elements.push(<h2 key={`h2-${i}`} className="text-lg font-extrabold text-white mt-5 mb-3 border-b border-white/10 pb-1">{parseInline(line.slice(3))}</h2>); continue; }
                            if (line.startsWith('# ')) { elements.push(<h1 key={`h1-${i}`} className="text-xl font-black text-white mt-6 mb-4 border-b border-white/10 pb-2">{parseInline(line.slice(2))}</h1>); continue; }
                            if (line.match(/^[-*]\s/)) { elements.push(<div key={`ul-${i}`} className="flex gap-2 ml-1 mb-1"><span className="text-indigo-400 font-bold mt-1.5 text-[10px]">‚Ä¢</span><span className="flex-1">{parseInline(line.replace(/^[-*]\s/, ''))}</span></div>); continue; }
                            if (line.match(/^\d+\.\s/)) { const match = line.match(/^(\d+)\.\s(.*)/); elements.push(<div key={`ol-${i}`} className="flex gap-2 ml-1 mb-1"><span className="text-indigo-400 font-mono font-bold">{match[1]}.</span><span className="flex-1">{parseInline(match[2])}</span></div>); continue; }
                            if (line.startsWith('> ')) { elements.push(<div key={`quote-${i}`} className="border-l-2 border-indigo-500/50 pl-3 py-2 my-2 text-gray-400 italic bg-white/5 rounded-r text-xs">{parseInline(line.slice(2))}</div>); continue; }
                            elements.push(<p key={`p-${i}`} className="mb-1.5">{parseInline(line)}</p>);
                        }
                        return <div key={index}>{elements}</div>;
                    })}
                </div>
            );
        };

        const ThinkingBlock = ({ content, isStreaming }) => {
            const [isOpen, setIsOpen] = useState(true);
            if (!content && !isStreaming) return null;
            return (
                <div className="mb-2 border border-indigo-500/20 bg-indigo-500/5 rounded-lg overflow-hidden">
                    <button onClick={() => setIsOpen(!isOpen)} className="w-full flex items-center justify-between px-3 py-1.5 bg-indigo-500/10 text-[10px] text-indigo-300 font-medium">
                        <div className="flex items-center gap-1.5">{isStreaming ? <Loader2 size={10} className="animate-spin" /> : <Brain size={10} />}<span>Ê∑±Â∫¶ÊÄùËÄÉ</span></div>
                        {isOpen ? <ChevronUp size={10} /> : <ChevronDown size={10} />}
                    </button>
                    {isOpen && <div className="p-2 text-indigo-200/60 text-[10px] font-mono whitespace-pre-wrap leading-relaxed max-h-32 overflow-y-auto">{content}</div>}
                </div>
            );
        };

        const ImageDisplay = ({ url, isBase64, t }) => {
            const [imgSrc, setImgSrc] = useState(url);
            const [status, setStatus] = useState('loading');
            useEffect(() => { setImgSrc(url); setStatus('loading'); }, [url]);
            const handleError = () => {
                if (status === 'loading' && !isBase64 && !imgSrc.includes('weserv.nl')) { setStatus('retry'); setImgSrc(`https://images.weserv.nl/?url=${encodeURIComponent(url)}&n=-1`); } 
                else { setStatus('error'); }
            };
            if (status === 'error') return (
                <div className="bg-gray-900/50 border border-white/10 rounded-xl p-4 flex flex-col items-center justify-center gap-3 text-center">
                    <div className="p-2 bg-red-500/10 rounded-full"><AlertTriangle size={18} className="text-red-400" /></div>
                    <div className="text-xs text-gray-400">{t('loadFail')}</div>
                    <a href={url} target="_blank" rel="noreferrer" className="px-3 py-1.5 bg-indigo-600 hover:bg-indigo-500 rounded-lg text-white text-xs font-bold flex items-center gap-1.5 transition-colors"><ExternalLink size={12} /> {t('openImg')}</a>
                </div>
            );
            return (
                <div className="relative group rounded-xl overflow-hidden border border-white/10 bg-black/20 min-h-[150px] flex items-center justify-center">
                    {status === 'loading' && <div className="absolute inset-0 flex items-center justify-center"><Loader2 size={20} className="animate-spin text-indigo-400" /></div>}
                    <img src={imgSrc} alt="Generated" className={`w-full h-auto max-h-[300px] object-contain bg-black/40 transition-opacity duration-300 ${status === 'loading' ? 'opacity-0' : 'opacity-100'}`} referrerPolicy="no-referrer" onLoad={() => setStatus('success')} onError={handleError} />
                    {status === 'success' && <a href={url} download={isBase64 ? "image.png" : undefined} target="_blank" rel="noreferrer" className="absolute bottom-2 right-2 p-2 bg-black/60 rounded-full text-white opacity-0 group-hover:opacity-100 transition-opacity backdrop-blur-sm hover:bg-black/80"><Download size={16} /></a>}
                </div>
            );
        };

        function OmniChat() {
            const [config, setConfig] = useState(DEFAULT_CONFIG);
            const [sessions, setSessions] = useState([]);
            const [activeSessionId, setActiveSessionId] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [showWelcome, setShowWelcome] = useState(false);
            const [showDonation, setShowDonation] = useState(false); // Donation Modal
            const [input, setInput] = useState('');
            const [isLoading, setIsLoading] = useState(false);
            const [mode, setMode] = useState('chat');
            const [useReasoning, setUseReasoning] = useState(false);
            const [images, setImages] = useState([]);
            const [isListening, setIsListening] = useState(false);
            const [fetchedModels, setFetchedModels] = useState([]);
            const [isFetchingModels, setIsFetchingModels] = useState(false);
            const [modelFetchError, setModelFetchError] = useState('');
            const messagesEndRef = useRef(null);
            const abortRef = useRef(null);

            useEffect(() => {
                const savedConfig = localStorage.getItem('omnichat_config_v21'); // v21
                let initialLang = 'zh-CN';
                if (savedConfig) {
                    const parsed = JSON.parse(savedConfig);
                    if (!parsed.api.systemPrompt) parsed.api.systemPrompt = '';
                    if (parsed.language) initialLang = parsed.language;
                    setConfig(prev => ({ ...prev, ...parsed, api: { ...prev.api, ...parsed.api } }));
                } else {
                    const browserLang = navigator.language;
                    if (browserLang.startsWith('zh')) initialLang = browserLang.includes('TW') || browserLang.includes('HK') ? 'zh-TW' : 'zh-CN';
                    else if (browserLang.startsWith('ja')) initialLang = 'ja-JP';
                    else initialLang = 'en-US';
                    setConfig(prev => ({ ...prev, language: initialLang }));
                    setShowSettings(true);
                }
                
                const savedSessions = localStorage.getItem('omnichat_sessions_v1');
                if (savedSessions) {
                    const parsedSessions = JSON.parse(savedSessions);
                    setSessions(parsedSessions);
                    if (parsedSessions.length > 0) setActiveSessionId(parsedSessions[0].id);
                    else createNewSession(initialLang);
                } else {
                    createNewSession(initialLang);
                }

                const welcomeSeen = localStorage.getItem('omnichat_welcome_seen');
                if (!welcomeSeen) setShowWelcome(true);
            }, []);

            useEffect(() => { localStorage.setItem('omnichat_config_v21', JSON.stringify(config)); }, [config]);
            useEffect(() => { if (sessions.length > 0) localStorage.setItem('omnichat_sessions_v1', JSON.stringify(sessions)); }, [sessions]);
            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [sessions, activeSessionId, isLoading]);

            const t = (key) => {
                const lang = config.language || 'zh-CN';
                return TRANSLATIONS[lang][key] || TRANSLATIONS['zh-CN'][key] || key;
            };

            const activeSession = sessions.find(s => s.id === activeSessionId) || { messages: [] };
            
            const createNewSession = (lang) => {
                const currentLang = lang || config.language || 'zh-CN';
                const newId = Date.now().toString();
                const newSession = { id: newId, title: TRANSLATIONS[currentLang].newChat, messages: [], created: Date.now() };
                setSessions(prev => [newSession, ...prev]);
                setActiveSessionId(newId);
                if (window.innerWidth < 768) setIsSidebarOpen(false);
                setMode('chat');
                return newId;
            };

            const deleteSession = (e, id) => {
                e.stopPropagation();
                const newSessions = sessions.filter(s => s.id !== id);
                setSessions(newSessions);
                if (newSessions.length === 0) createNewSession();
                else if (activeSessionId === id) setActiveSessionId(newSessions[0].id);
            };

            const updateActiveSessionMessages = (updater) => {
                setSessions(prev => prev.map(s => {
                    if (s.id === activeSessionId) {
                        const newMsgs = typeof updater === 'function' ? updater(s.messages) : updater;
                        let newTitle = s.title;
                        if (s.messages.length === 0 && newMsgs.length > 0 && newMsgs[0].role === 'user') {
                            newTitle = newMsgs[0].content.slice(0, 20) || (newMsgs[0].images.length ? 'Image' : t('newChat'));
                        }
                        return { ...s, messages: newMsgs, title: newTitle };
                    }
                    return s;
                }));
            };

            const updateConfig = (s, f, v) => setConfig(p => ({ ...p, [s]: { ...p[s], [f]: v } }));
            
            const closeWelcomeModal = () => {
                localStorage.setItem('omnichat_welcome_seen', 'true');
                setShowWelcome(false);
            };

            const fetchAvailableModels = async () => {
                const currentConfig = config.api;
                if (!currentConfig.apiKey) { setModelFetchError(t('keyError')); return; }
                const safeApiKey = currentConfig.apiKey.trim();
                setIsFetchingModels(true); setModelFetchError(''); setFetchedModels([]);
                try {
                    let baseUrl = currentConfig.baseUrl.replace(/\/chat\/completions\/?$/, '').replace(/\/+$/, '');
                    const res = await fetch(`${baseUrl}/models`, { method: 'GET', headers: { 'Authorization': `Bearer ${safeApiKey}` } });
                    if (!res.ok) throw new Error(`HTTP ${res.status}`);
                    const data = await res.json();
                    let arr = (data.data && Array.isArray(data.data)) ? data.data : (Array.isArray(data) ? data : []);
                    if (arr.length) setFetchedModels(arr.map(m => m.id || m).sort());
                    else throw new Error('Format Error');
                } catch (err) { 
                    console.error("Fetch Models Error:", err);
                    setModelFetchError(`${t('failed')}: ${err.message}`); 
                } finally { 
                    setIsFetchingModels(false); 
                }
            };

            const handleSend = async () => {
                if ((!input.trim() && !images.length) || isLoading) return;
                if (!config.api.apiKey) return setShowSettings(true);
                
                const newMsg = { role: 'user', content: input, images: [...images] };
                updateActiveSessionMessages(prev => [...prev, newMsg]);
                setInput(''); setImages([]); setIsLoading(true);
                
                abortRef.current = new AbortController();
                const apiKey = config.api.apiKey.trim();
                const baseUrl = config.api.baseUrl.replace(/\/+$/, '');

                try {
                    if (mode === 'chat') {
                        updateActiveSessionMessages(prev => [...prev, { role: 'assistant', content: '', isStreaming: true }]);
                        
                        let apiMessages = [];
                        if (config.api.systemPrompt) apiMessages.push({ role: 'system', content: config.api.systemPrompt });
                        const currentMsgs = [...activeSession.messages, newMsg]; 
                        apiMessages = [...apiMessages, ...currentMsgs.map(m => m.images?.length ? { role: m.role, content: [{ type: 'text', text: m.content }, ...m.images.map(u => ({ type: 'image_url', image_url: { url: u } }))] } : { role: m.role, content: m.content })];

                        const res = await fetch(`${baseUrl.endsWith('/chat/completions')?baseUrl:baseUrl+'/chat/completions'}`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify({
                                model: useReasoning ? config.api.reasoningModel : config.api.chatModel,
                                messages: apiMessages,
                                stream: true
                            }),
                            signal: abortRef.current.signal
                        });
                        if (!res.ok) throw new Error(`HTTP ${res.status}`);
                        const reader = res.body.getReader();
                        const decoder = new TextDecoder();
                        let text = '', reasoning = '';
                        
                        while (true) {
                            const { done, value } = await reader.read();
                            if (done) break;
                            const lines = decoder.decode(value, { stream: true }).split('\n');
                            for (const line of lines) {
                                if (line.startsWith('data: ') && !line.includes('[DONE]')) {
                                    try {
                                        const delta = JSON.parse(line.slice(6)).choices[0].delta;
                                        if (delta.reasoning_content) reasoning += delta.reasoning_content;
                                        if (delta.content) text += delta.content;
                                        const full = reasoning ? `<think>${reasoning}</think>\n${text}` : text;
                                        updateActiveSessionMessages(prev => {
                                            const n = [...prev];
                                            n[n.length-1].content = full;
                                            return n;
                                        });
                                    } catch (e) {}
                                }
                            }
                        }
                    } else {
                        updateActiveSessionMessages(prev => [...prev, { role: 'assistant', content: t('genStart'), isStreaming: true, type: mode }]);
                        const endpoint = mode === 'image' ? '/images/generations' : '/videos/generations';
                        const payload = { 
                            model: mode === 'image' ? config.api.imageModel : config.api.videoModel, 
                            prompt: newMsg.content, 
                            n: 1, size: "1024x1024",
                            response_format: mode === 'image' ? "b64_json" : undefined
                        };
                        if (newMsg.images.length) payload.image = newMsg.images[0];

                        const res = await fetch(`${baseUrl}${endpoint}`, {
                            method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();
                        if (!res.ok) throw new Error(data.error?.message || 'Generation failed');
                        
                        let mediaData = null;
                        let isB64 = false;
                        if (data.data?.[0]?.b64_json) { mediaData = `data:image/png;base64,${data.data[0].b64_json}`; isB64 = true; }
                        else { mediaData = data.data?.[0]?.url || data.output?.[0] || data.url || data.data?.[0]; }

                        if (!mediaData) throw new Error('No image data');
                        
                        updateActiveSessionMessages(prev => {
                            const n = [...prev];
                            const last = n[n.length-1];
                            last.isStreaming = false;
                            last.content = `${t('genSuccess')}: ${newMsg.content}`;
                            last.mediaUrl = mediaData;
                            last.isBase64 = isB64;
                            return n;
                        });
                    }
                } catch (e) {
                    if (e.name !== 'AbortError') {
                        updateActiveSessionMessages(prev => { const n = [...prev]; n[n.length-1].isError=true; n[n.length-1].content=`‚ùå ${t('failed')}: ${e.message}`; return n; });
                    }
                } finally { 
                    setIsLoading(false); 
                    updateActiveSessionMessages(prev => { const n = [...prev]; n[n.length-1].isStreaming = false; return n; });
                }
            };

            const handleImage = (e) => {
                Array.from(e.target.files).forEach(f => {
                    const r = new FileReader();
                    r.onload = () => setImages(p => [...p, r.result]);
                    r.readAsDataURL(f);
                });
            };

            const startListening = () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) return alert("Browser not supported");
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = config.language || 'zh-CN';
                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = () => setIsListening(false);
                recognition.onresult = (e) => {
                    if (e.results[0]?.[0]) setInput(p => p + (p ? ' ' : '') + e.results[0][0].transcript);
                };
                recognition.start();
            };

            const speakText = (text) => {
                if (!('speechSynthesis' in window)) return;
                const clean = text.replace(/<think>[\s\S]*?<\/think>/g, '').replace(/[*#`_>]/g, '');
                const u = new SpeechSynthesisUtterance(clean);
                u.lang = config.language || 'zh-CN';
                window.speechSynthesis.speak(u);
            };

            return (
                <div className="flex h-screen bg-[#000000] text-gray-100 overflow-hidden">
                    {showWelcome && <WelcomeModal onClose={closeWelcomeModal} t={t} />}
                    {showDonation && <DonationModal onClose={() => setShowDonation(false)} t={t} />}

                    {/* Sidebar */}
                    <div className={`fixed inset-y-0 left-0 z-50 w-64 glass-sidebar transform transition-transform duration-300 ease-in-out ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'} md:relative md:translate-x-0 flex flex-col`}>
                        <div className="p-4 flex items-center justify-between">
                            <h1 className="font-bold text-xl tracking-tight flex items-center gap-2"><Zap size={20} className="text-indigo-500"/> {t('title')}</h1>
                            <button onClick={()=>setIsSidebarOpen(false)} className="md:hidden p-1 text-gray-400"><X size={20}/></button>
                        </div>
                        <div className="px-3 pb-2">
                            <button onClick={()=>createNewSession()} className="w-full py-2.5 bg-white/5 hover:bg-white/10 border border-white/10 rounded-xl flex items-center justify-center gap-2 text-sm font-medium transition-all active:scale-95">
                                <Plus size={16} /> {t('newChat')}
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto px-3 py-2 space-y-1">
                            {sessions.map(s => (
                                <div key={s.id} onClick={()=>{setActiveSessionId(s.id); if(window.innerWidth<768) setIsSidebarOpen(false);}} className={`group flex items-center justify-between p-3 rounded-xl cursor-pointer transition-all ${activeSessionId===s.id ? 'bg-indigo-600 text-white' : 'hover:bg-white/5 text-gray-400 hover:text-gray-200'}`}>
                                    <div className="flex items-center gap-3 overflow-hidden">
                                        <MessageSquare size={16} className="flex-shrink-0" />
                                        <span className="text-sm truncate">{s.title}</span>
                                    </div>
                                    <button onClick={(e)=>deleteSession(e, s.id)} className={`p-1.5 rounded-full hover:bg-black/20 ${activeSessionId===s.id ? 'opacity-100' : 'opacity-0 group-hover:opacity-100'}`}>
                                        <Trash2 size={12} />
                                    </button>
                                </div>
                            ))}
                        </div>
                        <div className="p-3 border-t border-white/5 space-y-1">
                            <button onClick={() => setShowDonation(true)} className="flex items-center gap-3 text-sm text-amber-400 hover:text-amber-300 transition-colors w-full p-2 rounded-lg hover:bg-amber-500/10">
                                <Coffee size={18} /> <span>{t('donate')}</span>
                            </button>
                            <button onClick={()=>setShowSettings(true)} className="flex items-center gap-3 text-sm text-gray-400 hover:text-white transition-colors w-full p-2 rounded-lg hover:bg-white/5">
                                <Settings size={18} /> <span>{t('settings')}</span>
                            </button>
                        </div>
                    </div>

                    {isSidebarOpen && <div className="fixed inset-0 bg-black/60 z-40 md:hidden" onClick={()=>setIsSidebarOpen(false)}></div>}

                    <div className="flex-1 flex flex-col h-full relative w-full">
                        <header className="flex-none px-4 py-3 border-b border-white/10 bg-[#050505]/80 backdrop-blur-md z-30 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <button onClick={()=>setIsSidebarOpen(true)} className="md:hidden p-2 -ml-2 text-gray-400 hover:text-white"><Menu size={20}/></button>
                                <div>
                                    <h1 className="font-bold text-sm leading-none flex items-center gap-2">
                                        {mode==='chat' ? (useReasoning?config.api.reasoningModel:config.api.chatModel) : (mode==='image'?config.api.imageModel:config.api.videoModel)}
                                        <span className="px-1.5 py-0.5 rounded bg-white/10 text-[9px] font-mono text-gray-400">{mode.toUpperCase()}</span>
                                    </h1>
                                </div>
                            </div>
                        </header>

                        <main className="flex-1 overflow-y-auto p-3 pb-32">
                            <div className="max-w-3xl mx-auto space-y-6">
                                {activeSession.messages.length === 0 && (
                                    <div className="flex flex-col items-center justify-center h-64 text-gray-500 space-y-4">
                                        <div className="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center">
                                            <Bot size={32} className="opacity-50"/>
                                        </div>
                                        <p className="text-sm">{t('welcome')}</p>
                                    </div>
                                )}
                                {activeSession.messages.map((m, i) => (
                                    <div key={i} className={`flex gap-3 ${m.role==='user'?'justify-end':'justify-start'}`}>
                                        {m.role!=='user' && (
                                            <div className="flex flex-col gap-2">
                                                <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center flex-shrink-0 mt-1"><Bot size={14}/></div>
                                                {!m.mediaUrl && <button onClick={()=>speakText(m.content)} className="p-1 text-gray-600 hover:text-white self-center"><Volume2 size={12}/></button>}
                                            </div>
                                        )}
                                        <div className={`flex flex-col max-w-[88%] ${m.role==='user'?'items-end':'items-start'}`}>
                                            {m.images?.map((img,k)=><img key={k} src={img} className="max-h-48 rounded-lg mb-2 border border-white/10"/>)}
                                            <div className={`px-4 py-3 rounded-2xl text-sm ${m.role==='user'?'glass-bubble-user text-white rounded-tr-sm':'glass-bubble-bot text-gray-200 rounded-tl-sm'} shadow-sm`}>
                                                {m.mediaUrl ? <ImageDisplay url={m.mediaUrl} isBase64={m.isBase64} t={t} /> : (
                                                    m.content.includes('<think>') 
                                                    ? <><ThinkingBlock content={m.content.match(/<think>([\s\S]*?)<\/think>/)?.[1]} isStreaming={m.isStreaming} /><MarkdownRenderer content={m.content.replace(/<think>[\s\S]*?<\/think>/,'')} /></>
                                                    : <MarkdownRenderer content={m.content} />
                                                )}
                                                {m.isError && <div className="text-[10px] opacity-70 mt-1 font-mono text-red-300">{m.content}</div>}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                                <div ref={messagesEndRef} />
                            </div>
                        </main>

                        <div className="mobile-input-bar fixed bottom-0 w-full md:absolute md:w-full z-30 safe-bottom">
                            <div className="max-w-3xl mx-auto p-3">
                                <div className="flex justify-center mb-2">
                                    <div className="flex bg-black/40 rounded-full p-0.5 border border-white/10 backdrop-blur-xl">
                                        {['chat','image','video'].map(mo => (
                                            <button key={mo} onClick={()=>setMode(mo)} className={`px-4 py-1.5 rounded-full text-[10px] font-bold uppercase transition-all flex items-center gap-1.5 ${mode===mo ? 'bg-white/20 text-white shadow-sm' : 'text-gray-500 hover:text-gray-300'}`}>
                                                {mo==='chat' && <MessageSquarePlus size={12}/>}
                                                {mo==='image' && <ImageIcon size={12}/>}
                                                {mo==='video' && <Video size={12}/>}
                                                <span>{t(mo+'Mode')}</span>
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {images.length > 0 && (
                                    <div className="flex gap-2 overflow-x-auto px-2 mb-2">
                                        {images.map((img, i) => (
                                            <div key={i} className="relative flex-shrink-0"><img src={img} className="h-12 w-12 rounded-lg object-cover border border-white/20"/><button onClick={()=>setImages(p=>p.filter((_,x)=>x!==i))} className="absolute -top-1 -right-1 bg-red-500 text-white rounded-full p-0.5"><X size={10}/></button></div>
                                        ))}
                                    </div>
                                )}

                                <div className="flex items-end gap-2 bg-[#1a1a1c] border border-white/10 rounded-[1.25rem] p-1.5 shadow-xl">
                                    <label className="p-2.5 text-gray-400 hover:text-white cursor-pointer transition-transform active:scale-90 rounded-full hover:bg-white/5"><input type="file" accept="image/*" multiple className="hidden" onChange={handleImage}/><ImageIcon size={20} /></label>
                                    <textarea
                                        value={input}
                                        onChange={(e)=>setInput(e.target.value)}
                                        onKeyDown={(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();handleSend()}}}
                                        placeholder={isListening ? t('listening') : (mode==='chat'?t('inputChat'):(mode==='image'?t('inputImage'):t('inputVideo')))}
                                        className="flex-1 bg-transparent border-none focus:ring-0 text-white text-sm py-2.5 max-h-32 resize-none placeholder-gray-500 leading-relaxed"
                                        rows={1}
                                    />
                                    {mode === 'chat' && (
                                        <>
                                            <button onClick={startListening} className={`p-2.5 rounded-full transition-all ${isListening?'text-red-400 bg-red-500/10 animate-pulse':'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                                                <Mic size={20} />
                                            </button>
                                            <button onClick={()=>setUseReasoning(!useReasoning)} className={`p-2.5 rounded-full transition-all ${useReasoning?'text-indigo-400 bg-indigo-500/10':'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                                                <Brain size={20} />
                                            </button>
                                        </>
                                    )}
                                    <button onClick={isLoading?()=>abortRef.current?.abort():handleSend} disabled={!input.trim()&&!images.length&&!isLoading} className={`p-2.5 rounded-xl transition-all shadow-lg ${isLoading?'bg-red-500/80 text-white':'bg-white text-black hover:scale-105 active:scale-95'}`}>
                                        {isLoading ? <div className="w-5 h-5 rounded-sm border-2 border-current border-t-transparent animate-spin"/> : <Send size={20} />}
                                    </button>
                                </div>
                            </div>
                        </div>

                        {showSettings && (
                            <div className="fixed inset-0 z-[60] bg-black/80 backdrop-blur-sm flex items-end md:items-center justify-center p-4 animate-in fade-in duration-200">
                                <div className="w-full max-w-lg bg-[#121214] border border-white/10 rounded-3xl p-6 shadow-2xl max-h-[85vh] overflow-y-auto">
                                    <div className="flex justify-between items-center mb-6">
                                        <h2 className="text-lg font-bold text-white flex items-center gap-2"><Settings size={18}/> {t('configTitle')}</h2>
                                        <div className="flex items-center gap-2">
                                            <div className="bg-white/10 rounded-lg p-1 flex gap-1">
                                                {['zh-CN','zh-TW','en-US','ja-JP'].map(l => (
                                                    <button key={l} onClick={()=>setConfig(p=>({...p, language:l}))} className={`text-[10px] px-2 py-1 rounded ${config.language===l ? 'bg-white text-black font-bold' : 'text-gray-400'}`}>
                                                        {l==='zh-CN'?'ÁÆÄ':l==='zh-TW'?'ÁπÅ':l==='en-US'?'EN':'JP'}
                                                    </button>
                                                ))}
                                            </div>
                                            <button onClick={()=>setShowSettings(false)} className="p-1.5 bg-white/10 rounded-full hover:bg-white/20"><X size={16}/></button>
                                        </div>
                                    </div>
                                    <div className="space-y-5">
                                        <div className="space-y-1.5">
                                            <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">{t('apiConfig')}</label>
                                            <input type="text" value={config.api.baseUrl} onChange={(e)=>updateConfig('api','baseUrl',e.target.value)} className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-xs text-gray-200 font-mono mb-2 focus:border-indigo-500/50 outline-none" placeholder="Base URL" />
                                            <input type="password" value={config.api.apiKey} onChange={(e)=>updateConfig('api','apiKey',e.target.value)} className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-xs text-gray-200 font-mono focus:border-indigo-500/50 outline-none" placeholder="sk-..." />
                                        </div>
                                        
                                        <div className="space-y-2">
                                            <div className="flex justify-between items-center">
                                                <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">{t('models')}</label>
                                                <button onClick={fetchAvailableModels} disabled={isFetchingModels} className="text-[10px] text-indigo-400 hover:text-white flex items-center gap-1 transition-colors">
                                                    {isFetchingModels ? <Loader2 size={10} className="animate-spin" /> : <RefreshCw size={10} />} 
                                                    {isFetchingModels ? t('updating') : t('refresh')}
                                                </button>
                                            </div>
                                            {modelFetchError && <p className="text-[10px] text-red-400 bg-red-900/10 p-1 rounded">{modelFetchError}</p>}
                                            {fetchedModels.length > 0 && <p className="text-[10px] text-green-400 bg-green-900/10 p-1 rounded">{t('updated')} {fetchedModels.length} {t('modelsCount')}</p>}
                                            
                                            <div className="grid grid-cols-2 gap-3">
                                                {[
                                                    {l:'Chat',k:'chatModel'},{l:'Reasoning',k:'reasoningModel'},
                                                    {l:'Image',k:'imageModel'},{l:'Video',k:'videoModel'}
                                                ].map(f => (
                                                    <div key={f.k}>
                                                        <label className="text-[9px] text-gray-500 block mb-1">{f.l}</label>
                                                        {fetchedModels.length > 0 && <select onChange={(e)=>updateConfig('api',f.k,e.target.value)} className="w-full bg-black/30 border border-white/10 rounded-lg p-1.5 text-[10px] mb-1 text-gray-300 outline-none" value={config.api[f.k]}>{fetchedModels.map(m=><option key={m} value={m}>{m}</option>)}</select>}
                                                        <input type="text" value={config.api[f.k]} onChange={(e)=>updateConfig('api',f.k,e.target.value)} className="w-full bg-black/30 border border-white/10 rounded-lg p-2 text-[10px] text-white outline-none focus:border-indigo-500/50" placeholder={f.l}/>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>

                                        <div className="space-y-1.5">
                                            <label className="text-[10px] font-bold text-gray-500 uppercase tracking-wider">{t('systemPrompt')}</label>
                                            <textarea 
                                                value={config.api.systemPrompt || ''} 
                                                onChange={(e)=>updateConfig('api','systemPrompt',e.target.value)} 
                                                className="w-full bg-black/30 border border-white/10 rounded-xl p-3 text-xs text-gray-200 font-mono min-h-[80px] focus:border-indigo-500/50 outline-none resize-none" 
                                                placeholder={t('systemPromptPlace')}
                                            />
                                        </div>
                                    </div>
                                    <button onClick={()=>setShowSettings(false)} className="w-full mt-6 bg-white text-black font-bold py-3.5 rounded-xl text-sm hover:bg-gray-200 transition-colors">{t('save')}</button>
                                    <p className="text-center text-[10px] text-gray-600 mt-4 uppercase tracking-widest">{t('designedBy')}</p>
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        }

        createRoot(document.getElementById('root')).render(<OmniChat />);
    </script>
</body>
</html>
